#!/bin/bash
# Flowless CLI - Command-line interface for managing flowless backends

set -euo pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(cd "${SCRIPT_DIR}/../lib" && pwd)"

# Source libraries
source "${LIB_DIR}/process-manager.sh"
source "${LIB_DIR}/resource-monitor.sh"
source "${LIB_DIR}/config-loader.sh"

# Colors for output
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    BOLD=''
    NC=''
fi

# Backend configuration
get_backend_info() {
    local backend="$1"
    
    case "$backend" in
        paqet)
            echo "name=Paqet"
            echo "service=paqet"
            echo "port=1080"
            echo "binary=/opt/flowless/bin/paqet"
            echo "config=/etc/flowless/paqet.conf"
            ;;
        gfw-knocker|gfk)
            echo "name=GFW-Knocker"
            echo "service=gfw-knocker"
            echo "port=14000"
            echo "binary=/opt/flowless/bin/xray"
            echo "config=/etc/flowless/gfw-knocker.conf"
            ;;
        *)
            return 1
            ;;
    esac
}

# Normalize backend name
normalize_backend() {
    local backend="$1"
    case "$backend" in
        gfk) echo "gfw-knocker" ;;
        *) echo "$backend" ;;
    esac
}

# Get list of installed backends
get_installed_backends() {
    local backends=()
    
    if systemctl list-unit-files 2>/dev/null | grep -q "^paqet.service"; then
        backends+=("paqet")
    fi
    
    if systemctl list-unit-files 2>/dev/null | grep -q "^gfw-knocker.service"; then
        backends+=("gfw-knocker")
    fi
    
    echo "${backends[@]}"
}

# Show usage
show_usage() {
    cat << EOF
${BOLD}Flowless CLI${NC} - Process management for flowless backends

${BOLD}USAGE:${NC}
    flowless <command> [options]

${BOLD}COMMANDS:${NC}
    status [backend]         Show detailed status of backends
    start <backend>          Start a backend service
    stop <backend>           Stop a backend service
    restart <backend>        Restart a backend service
    stats [backend]          Show resource usage statistics
    watch [backend]          Real-time monitoring (Ctrl+C to exit)
    list                     List installed backends
    help                     Show this help message

${BOLD}BACKENDS:${NC}
    paqet                    Paqet KCP relay
    gfw-knocker, gfk         GFW-Knocker multi-protocol relay

${BOLD}EXAMPLES:${NC}
    flowless status          # Show all backends
    flowless restart paqet   # Restart Paqet
    flowless stats           # Show resource usage
    flowless watch           # Live monitoring

${BOLD}NOTES:${NC}
    • Most commands require root privileges
    • Use systemctl for permanent changes (enable/disable)
    • Logs are in /var/log/flowless/ and journalctl

EOF
}

# Show backend status
show_status() {
    local specific_backend="${1:-}"
    
    echo -e "${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BOLD}║           FLOWLESS - PROCESS STATUS                       ║${NC}"
    echo -e "${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    local backends
    if [ -n "$specific_backend" ]; then
        specific_backend=$(normalize_backend "$specific_backend")
        backends="$specific_backend"
    else
        backends=$(get_installed_backends)
    fi
    
    if [ -z "$backends" ]; then
        echo "No backends installed."
        return
    fi
    
    for backend in $backends; do
        local info
        info=$(get_backend_info "$backend")
        local name=$(echo "$info" | grep '^name=' | cut -d= -f2)
        local service=$(echo "$info" | grep '^service=' | cut -d= -f2)
        local port=$(echo "$info" | grep '^port=' | cut -d= -f2)
        
        echo -e "┌─ ${BOLD}$name${NC}"
        
        # Check systemd service status
        if systemctl is-active "$service" >/dev/null 2>&1; then
            local stats
            stats=$(get_process_stats "$backend" "$port" 2>/dev/null || echo "status=error")
            
            local status=$(echo "$stats" | grep '^status=' | cut -d= -f2)
            
            if [ "$status" = "running" ]; then
                local pid=$(echo "$stats" | grep '^pid=' | cut -d= -f2)
                local cpu=$(echo "$stats" | grep '^cpu=' | cut -d= -f2)
                local mem_mb=$(echo "$stats" | grep '^mem_mb=' | cut -d= -f2)
                local uptime_str=$(echo "$stats" | grep '^uptime_str=' | cut -d= -f2)
                local conns=$(echo "$stats" | grep '^connections=' | cut -d= -f2)
                
                echo -e "│ Status:      ${GREEN}● Running${NC}"
                echo -e "│ PID:         $pid"
                echo -e "│ Uptime:      $uptime_str"
                echo -e "│ CPU:         ${cpu}%"
                echo -e "│ Memory:      ${mem_mb} MB"
                echo -e "│ Connections: $conns"
                
                # Port check
                if check_port_listening "$port"; then
                    echo -e "│ Port:        ${GREEN}$port (listening)${NC}"
                else
                    echo -e "│ Port:        ${YELLOW}$port (NOT listening) ⚠${NC}"
                fi
            else
                echo -e "│ Status:      ${YELLOW}● Starting/Unhealthy${NC}"
            fi
        else
            echo -e "│ Status:      ${RED}○ Stopped${NC}"
        fi
        
        echo "└─"
        echo ""
    done
}

# Show resource statistics
show_stats() {
    local specific_backend="${1:-}"
    
    echo -e "${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BOLD}║           FLOWLESS - RESOURCE STATISTICS                  ║${NC}"
    echo -e "${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    local backends
    if [ -n "$specific_backend" ]; then
        specific_backend=$(normalize_backend "$specific_backend")
        backends="$specific_backend"
    else
        backends=$(get_installed_backends)
    fi
    
    if [ -z "$backends" ]; then
        echo "No backends installed."
        return
    fi
    
    # Table header
    printf "${BOLD}%-15s %-10s %-8s %-10s %-12s %-10s${NC}\n" \
        "Backend" "Status" "CPU" "Memory" "Connections" "Uptime"
    echo "────────────────────────────────────────────────────────────────────"
    
    for backend in $backends; do
        local info
        info=$(get_backend_info "$backend")
        local name=$(echo "$info" | grep '^name=' | cut -d= -f2)
        local port=$(echo "$info" | grep '^port=' | cut -d= -f2)
        
        local stats
        stats=$(get_process_stats "$backend" "$port" 2>/dev/null || echo "status=stopped")
        
        local status=$(echo "$stats" | grep '^status=' | cut -d= -f2)
        
        if [ "$status" = "running" ]; then
            local cpu=$(echo "$stats" | grep '^cpu=' | cut -d= -f2)
            local mem_mb=$(echo "$stats" | grep '^mem_mb=' | cut -d= -f2)
            local uptime_str=$(echo "$stats" | grep '^uptime_str=' | cut -d= -f2)
            local conns=$(echo "$stats" | grep '^connections=' | cut -d= -f2)
            
            printf "%-15s ${GREEN}%-10s${NC} %-8s %-10s %-12s %-10s\n" \
                "$name" "Running" "${cpu}%" "${mem_mb} MB" "$conns" "$uptime_str"
        else
            printf "%-15s ${RED}%-10s${NC} %-8s %-10s %-12s %-10s\n" \
                "$name" "Stopped" "-" "-" "-" "-"
        fi
    done
    
    echo ""
    
    # System stats
    local sys_stats
    sys_stats=$(get_system_stats)
    local total_mem=$(echo "$sys_stats" | grep '^total_mem_mb=' | cut -d= -f2)
    local avail_mem=$(echo "$sys_stats" | grep '^avail_mem_mb=' | cut -d= -f2)
    local load=$(echo "$sys_stats" | grep '^load_average=' | cut -d= -f2)
    
    echo -e "${BOLD}System:${NC}"
    echo "  • Load average: $load"
    echo "  • Memory: ${avail_mem} MB available / ${total_mem} MB total"
}

# Start a backend
cmd_start() {
    local backend="$1"
    backend=$(normalize_backend "$backend")
    
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}Error: This command requires root privileges${NC}" >&2
        exit 1
    fi
    
    local info
    info=$(get_backend_info "$backend") || {
        echo -e "${RED}Error: Unknown backend: $backend${NC}" >&2
        exit 1
    }
    
    local service=$(echo "$info" | grep '^service=' | cut -d= -f2)
    
    echo "Starting $backend via systemd..."
    systemctl start "$service"
    echo -e "${GREEN}$backend started${NC}"
}

# Stop a backend
cmd_stop() {
    local backend="$1"
    backend=$(normalize_backend "$backend")
    
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}Error: This command requires root privileges${NC}" >&2
        exit 1
    fi
    
    local info
    info=$(get_backend_info "$backend") || {
        echo -e "${RED}Error: Unknown backend: $backend${NC}" >&2
        exit 1
    }
    
    local service=$(echo "$info" | grep '^service=' | cut -d= -f2)
    
    echo "Stopping $backend via systemd..."
    systemctl stop "$service"
    echo -e "${GREEN}$backend stopped${NC}"
}

# Restart a backend
cmd_restart() {
    local backend="$1"
    backend=$(normalize_backend "$backend")
    
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}Error: This command requires root privileges${NC}" >&2
        exit 1
    fi
    
    local info
    info=$(get_backend_info "$backend") || {
        echo -e "${RED}Error: Unknown backend: $backend${NC}" >&2
        exit 1
    }
    
    local service=$(echo "$info" | grep '^service=' | cut -d= -f2)
    
    echo "Restarting $backend via systemd..."
    systemctl restart "$service"
    echo -e "${GREEN}$backend restarted${NC}"
}

# Live monitoring
cmd_watch() {
    local specific_backend="${1:-}"
    
    if [ -n "$specific_backend" ]; then
        specific_backend=$(normalize_backend "$specific_backend")
    fi
    
    # Clear screen function
    clear_screen() {
        echo -e "\033[2J\033[H"
    }
    
    while true; do
        clear_screen
        
        echo -e "${BOLD}Flowless Live Monitor${NC} (refresh: 2s)                 Press Ctrl+C to exit"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        
        local backends
        if [ -n "$specific_backend" ]; then
            backends="$specific_backend"
        else
            backends=$(get_installed_backends)
        fi
        
        if [ -z "$backends" ]; then
            echo "No backends installed."
        else
            # Table header
            printf "${BOLD}%-15s %-10s %-8s %-8s %-10s %-12s %-10s${NC}\n" \
                "Backend" "Status" "PID" "CPU" "Memory" "Connections" "Uptime"
            echo "────────────────────────────────────────────────────────────────────────────"
            
            for backend in $backends; do
                local info
                info=$(get_backend_info "$backend")
                local name=$(echo "$info" | grep '^name=' | cut -d= -f2)
                local port=$(echo "$info" | grep '^port=' | cut -d= -f2)
                
                local stats
                stats=$(get_process_stats "$backend" "$port" 2>/dev/null || echo "status=stopped")
                
                local status=$(echo "$stats" | grep '^status=' | cut -d= -f2)
                
                if [ "$status" = "running" ]; then
                    local pid=$(echo "$stats" | grep '^pid=' | cut -d= -f2)
                    local cpu=$(echo "$stats" | grep '^cpu=' | cut -d= -f2)
                    local mem_mb=$(echo "$stats" | grep '^mem_mb=' | cut -d= -f2)
                    local uptime_str=$(echo "$stats" | grep '^uptime_str=' | cut -d= -f2)
                    local conns=$(echo "$stats" | grep '^connections=' | cut -d= -f2)
                    
                    printf "%-15s ${GREEN}%-10s${NC} %-8s %-8s %-10s %-12s %-10s\n" \
                        "$name" "Running" "$pid" "${cpu}%" "${mem_mb} MB" "$conns" "$uptime_str"
                else
                    printf "%-15s ${RED}%-10s${NC} %-8s %-8s %-10s %-12s %-10s\n" \
                        "$name" "Stopped" "-" "-" "-" "-" "-"
                fi
            done
        fi
        
        echo ""
        echo -e "${BOLD}System:${NC}"
        local sys_stats
        sys_stats=$(get_system_stats)
        local load=$(echo "$sys_stats" | grep '^load_average=' | cut -d= -f2)
        echo "  • Load average: $load"
        
        sleep 2
    done
}

# List installed backends
cmd_list() {
    echo -e "${BOLD}Installed Backends:${NC}"
    echo ""
    
    local backends
    backends=$(get_installed_backends)
    
    if [ -z "$backends" ]; then
        echo "No backends installed."
        return
    fi
    
    for backend in $backends; do
        local info
        info=$(get_backend_info "$backend")
        local name=$(echo "$info" | grep '^name=' | cut -d= -f2)
        local service=$(echo "$info" | grep '^service=' | cut -d= -f2)
        local port=$(echo "$info" | grep '^port=' | cut -d= -f2)
        
        echo -e "  • ${BOLD}$name${NC}"
        echo "    Service: $service"
        echo "    Port:    $port"
        echo ""
    done
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_status
        exit 0
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        status)
            show_status "$@"
            ;;
        stats)
            show_stats "$@"
            ;;
        start)
            if [ $# -eq 0 ]; then
                echo -e "${RED}Error: Backend name required${NC}" >&2
                echo "Usage: flowless start <backend>" >&2
                exit 1
            fi
            cmd_start "$1"
            ;;
        stop)
            if [ $# -eq 0 ]; then
                echo -e "${RED}Error: Backend name required${NC}" >&2
                echo "Usage: flowless stop <backend>" >&2
                exit 1
            fi
            cmd_stop "$1"
            ;;
        restart)
            if [ $# -eq 0 ]; then
                echo -e "${RED}Error: Backend name required${NC}" >&2
                echo "Usage: flowless restart <backend>" >&2
                exit 1
            fi
            cmd_restart "$1"
            ;;
        watch)
            cmd_watch "$@"
            ;;
        list)
            cmd_list
            ;;
        help|-h|--help)
            show_usage
            ;;
        *)
            echo -e "${RED}Error: Unknown command: $command${NC}" >&2
            echo "" >&2
            show_usage >&2
            exit 1
            ;;
    esac
}

main "$@"
